<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat App</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <!-- Login Section -->
  <div id="authsection">
    <input type="text" id="username" placeholder="Enter Username">
    <button id="loginbtn">Login</button>
  </div>

  <!-- Chat Section -->
  <div id="chatsection" style="display: none;">
    <!-- User List -->
    <div class="userlist">
      <ul id="users"></ul>
    </div>

    <!-- Chatbox -->
    <div class="chatbox">
      <h2 id="user">User</h2>
      <div class="messages"></div>
      <div class="input-area">
        <input type="text" id="message" placeholder="Enter message">
        <button id="sendbtn">Send</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script>
    const socket = io("https://whats-app-clone-40jh.onrender.com")
    const usernameInput = document.getElementById("username")
    const loginBtn = document.getElementById("loginbtn")
    const authSection = document.getElementById("authsection")
    const chatSection = document.getElementById("chatsection")
    const usersList = document.getElementById("users")
    const messageInput = document.getElementById("message")
    const sendBtn = document.getElementById("sendbtn")
    const messagesDiv = document.querySelector(".messages")

    let selectedUser = null

    loginBtn.addEventListener("click", () => {
      let username = usernameInput.value
      if (!username) return alert("please enter username")
      socket.emit("login", username)
      usernameInput.value = ""
      authSection.style.display = "none"
      chatSection.style.display = "flex"
    })

    socket.on("messageFromServer", (msg, classname) => {
      const div = document.createElement("div")
      div.className = "message " + classname
      div.innerText = msg
      messagesDiv.appendChild(div)
      scrollToBottom()
    })

    socket.on("users", (users, curruser) => {
      usersList.innerHTML = ""
      Object.entries(users).forEach(([username, id]) => {
        if(curruser === username) return
        const li = document.createElement("li")
        li.innerText = username
        li.onclick = () => {
          selectedUser = username
          socket.emit("getPrivateMessages", username)
        }
        usersList.appendChild(li)
      })
    })

    socket.on("loadOldMessages", (msgs, username, withUser) => {
      document.getElementById("user").innerText = `${withUser}`
      messagesDiv.innerHTML = ""
      msgs.forEach(msg => {
        const div = document.createElement("div")
        div.className = "message"
        if (msg.sender === username) {
          div.classList.add("my-message")
        } else {
          div.classList.add("other-message")
        }
        div.innerText = `${msg.message}`
        messagesDiv.appendChild(div)
      })
      scrollToBottom()
    })

    sendBtn.addEventListener("click", () => {
      const msg = messageInput.value
      if (!msg) return alert("please enter message")
      if (!selectedUser) return alert("please select user to send private message")
      socket.emit("privateMessage", { to: selectedUser, msg })
      messageInput.value = ""
    })

    function scrollToBottom() {
      messagesDiv.scrollTop = messagesDiv.scrollHeight
    }
  </script>
</body>

</html>
